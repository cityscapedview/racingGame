<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Racing Game</title>
  </head>
  <body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <script>
      var carPic = document.createElement("img");
      var carPicLoaded = false;

      let carX = 75;
      let carY = 75;
      let carAng = 0;
      let carSpeed = 0;

      const TRACK_W = 40;
      const TRACK_H = 40;
      const TRACK_GAP = 2;
      const TRACK_COLS = 20;
      const TRACK_ROWS = 15;
      let trackGrid = [
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
        1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1,
        0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0,
        0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0,
        0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0,
        1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0,
        0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
      ];

      let canvas, canvasContext;

      const KEY_LEFT_ARROW = 37;
      const KEY_UP_ARROW = 38;
      const KEY_RIGHT_ARROW = 39;
      const KEY_DOWN_ARROW = 40;

      let keyHeld_Gas = false;
      let keyHeld_Reverse = false;
      let keyHeld_TurnLeft = false;
      let keyHeld_TurnRight = false;

      let mouseX = 0;
      let mouseY = 0;

      function updateMousePos(evt) {
        let rect = canvas.getBoundingClientRect();
        let root = document.documentElement;

        mouseX = evt.clientX - rect.left - root.scrollLeft;
        mouseY = evt.clientY - rect.top - root.scrollTop;

        // cheat / hack to test car in any position
        // carX = mouseX;
        // carY = mouseY;
        // carSpeedX = 4;
        // carSpeedY = -4;
      }

      function keyPressed(evt) {
        // console.log("evt.keyCode");
        if (evt.keyCode == KEY_LEFT_ARROW) {
          keyHeld_TurnLeft = true;
        }
        if (evt.keyCode == KEY_RIGHT_ARROW) {
          keyHeld_TurnRight = true;
        }
        if (evt.keyCode == KEY_UP_ARROW) {
          keyHeld_Gas = true;
        }
        if (evt.keyCode == KEY_DOWN_ARROW) {
          keyHeld_Reverse = true;
        }
      }

      function keyReleased(evt) {
        if (evt.keyCode == KEY_LEFT_ARROW) {
          keyHeld_TurnLeft = false;
        }
        if (evt.keyCode == KEY_RIGHT_ARROW) {
          keyHeld_TurnRight = false;
        }
        if (evt.keyCode == KEY_UP_ARROW) {
          keyHeld_Gas = false;
        }
        if (evt.keyCode == KEY_DOWN_ARROW) {
          keyHeld_Reverse = false;
        }
      }

      window.onload = function () {
        canvas = document.getElementById("gameCanvas");
        canvasContext = canvas.getContext("2d");

        let framesPerSecond = 30;
        setInterval(updateAll, 1000 / framesPerSecond);

        canvas.addEventListener("mousemove", updateMousePos);

        document.addEventListener("keydown", keyPressed);
        document.addEventListener("keyup", keyReleased);

        carPic.onload = function () {
          carPicLoaded = true;
        };
        carPic.src = "akira.png";

        carReset();
      };

      function updateAll() {
        moveAll();
        drawAll();
      }

      function carReset() {
        for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++) {
          for (let eachCol = 0; eachCol < TRACK_COLS; eachCol++) {
            var arrayIndex = rowColToArrayIndex(eachCol, eachRow);

            if (trackGrid[arrayIndex] == 2) {
              trackGrid[arrayIndex] = 0;
              carAng = -Math.PI / 2;
              carX = eachCol * TRACK_W + TRACK_W / 2;
              carY = eachRow * TRACK_H + TRACK_H / 2;
            }
          }
        }
      }

      function carMove() {
        carSpeed *= 0.97;
        if (keyHeld_Gas) {
          carSpeed += 0.3;
        }
        if (keyHeld_Reverse) {
          carSpeed -= 0.3;
        }
        if (keyHeld_TurnLeft) {
          carAng -= 0.04;
        }
        if (keyHeld_TurnRight) {
          carAng += 0.04;
        }

        carX += Math.cos(carAng) * carSpeed;
        carY += Math.sin(carAng) * carSpeed;
      }

      function isTrackAtColRow(col, row) {
        if (col >= 0 && col < TRACK_COLS && row >= 0 && row < TRACK_ROWS) {
          let trackIndexUnderCoord = rowColToArrayIndex(col, row);
          return trackGrid[trackIndexUnderCoord] == 1;
        } else {
          return false;
        }
      }

      function carTrackHandling() {
        let carTrackCol = Math.floor(carX / TRACK_W);
        let carTrackRow = Math.floor(carY / TRACK_H);
        let trackIndexUnderCall = rowColToArrayIndex(carTrackCol, carTrackRow);

        if (
          carTrackCol >= 0 &&
          carTrackCol < TRACK_COLS &&
          carTrackRow >= 0 &&
          carTrackRow < TRACK_ROWS
        ) {
          if (isTrackAtColRow(carTrackCol, carTrackRow)) {
            carX -= Math.cos(carAng) * carSpeed;
            carY -= Math.sin(carAng) * carSpeed;

            carSpeed *= -0.5;
          } // end of track found
        } // end of valid col and row
      } // end of carTrackHandling funcction

      function moveAll() {
        carMove();

        carTrackHandling();
      }

      function rowColToArrayIndex(col, row) {
        return col + TRACK_COLS * row;
      }

      function drawTracks() {
        for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++) {
          for (let eachCol = 0; eachCol < TRACK_COLS; eachCol++) {
            var arrayIndex = rowColToArrayIndex(eachCol, eachRow);

            if (trackGrid[arrayIndex] == 1) {
              colorRect(
                TRACK_W * eachCol,
                TRACK_H * eachRow,
                TRACK_W - TRACK_GAP,
                TRACK_H - TRACK_GAP,
                "blue"
              );
            } // end of is this track here
          } // end of for each track
        } // end of eachRow
      } // end of drawTracks() func

      function drawAll() {
        //clear screen
        colorRect(0, 0, canvas.width, canvas.height, "black");

        //draw car
        // colorCircle(carX, carY, 10, "white");
        if (carPicLoaded) {
          drawBitmapWithRotation(carPic, carX, carY, carAng);
        }

        drawTracks();
      }

      function drawBitmapWithRotation(useBitmap, atX, atY, withAng) {
        canvasContext.save();
        canvasContext.translate(atX, atY);
        canvasContext.rotate(withAng);
        canvasContext.drawImage(
          useBitmap,
          -useBitmap.width / 2,
          -useBitmap.height / 2
        );
        canvasContext.restore();
      }

      function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
      }

      function colorCircle(centerX, centerY, radius, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.beginPath();
        canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
        canvasContext.fill();
      }

      function colorText(showWords, textX, textY, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.fillText(showWords, textX, textY);
      }
    </script>
  </body>
</html>
